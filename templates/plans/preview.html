<link rel="stylesheet" href="<#ROOTHTML#>templates/plans/basic.css">
[#if PLAN_NEED_ZOOM="1"#]
<script type="text/javascript" src="<#ROOTHTML#>3rdparty/svg-pan-zoom/svg-pan-zoom.min.js"></script>
[#endif#]
<div id="plan[#PLAN_ID#]" style="display:none;" class="svg_content">[#SVG_CONTENT#]</div>
<script type="application/javascript">

    var noPlanUpdatesTimer=0;
    var checkPlanTimer=0;
    var subscribedPlanWebSockets=0;
    var subscribedPlanWebSocketsTimer = 0;

    function planZoom() {
        var zoom = $(window).width()/$("#plan[#PLAN_ID#] svg").first().width()*100;
        document.body.style.zoom = zoom+"%"
    }

    function processPlanStates(data) {
        var obj=jQuery.parseJSON(data);
        if (typeof obj !='object') return false;
        clearTimeout(noPlanUpdatesTimer);
        noPlanUpdatesTimer=setTimeout("$.publish('plansNoUpdates');", 30*60*1000);
        var objCnt = obj.length;
        if (objCnt) {
            for (var i = 0; i < objCnt; i++) {
                var elem=$('#'+obj[i].ITEM);
                if (typeof obj[i].CONTENT === "undefined") {
                    elem.attr("class", "");
                    if (obj[i].SET_CLASS!='') {
                        elem.addClass(obj[i].SET_CLASS);
                    } else {
                        //elem.attr("class", "");
                        //elem.removeClass();
                    }
                } else {
                    elem.text(obj[i].CONTENT);
                }
            }
        }
    }

    function checkAllPlanStates() {
        clearTimeout(checkPlanTimer);
        if (subscribedPlanWebSockets==1) {
            checkPlanTimer=setTimeout('checkAllPlanStates();', 10000);
            return;
        }
        var url="<#ROOTHTML#>ajax/plans.html?op=checkAllStates&plan_id=<#PLAN_ID#>";
        $.ajax({
            url: url,
        }).done(function(data) {
            processPlanStates(data);
            checkPlanTimer=setTimeout('checkAllPlanStates();', 10000);
        });
        return false;
    }

    function subscribeToPlan() {
        console.log('Sending plan subscription request...');
        var payload;
        payload = new Object();
        payload.action = 'Subscribe';
        payload.data = new Object();
        payload.data.TYPE='plans';
        payload.data.PLAN_ID='[#PLAN_ID#]';
        wsSocket.send(JSON.stringify(payload));
        subscribedPlanWebSocketsTimer=setTimeout('subscribeToPlan();', 3000);
        return false;
    }

    $.subscribe('wsConnected', function (_) {
        subscribeToPlan();
    });

    $.subscribe('wsData', function (_, response) {
        if (response.action=='subscribed') {
            console.log('Plan Subscription confirmed.');
            clearTimeout(subscribedPlanWebSocketsTimer);
            subscribedPlanWebSockets=1;
        }
        if (response.action=='plan_states') {
            processPlanStates(response.data);
        }
    });

    $(document).ready(function(){
        [#begin STATES#]
        [#if SET_CLASS!=""#]
        $('#[#ITEM#]').addClass('[#SET_CLASS#]');
        [#endif#]
        [#if CAN_BE_CLICKED="1"#]
        $('#[#ITEM#]').click(function (e) {
            var window_url='';
            [#if MENU_ITEM_ID!="0"#]
            window_url='<#ROOTHTML#>menu.html?parent=[#MENU_ITEM_ID#]';
            [#endif MENU_ITEM_ID#]
            [#if HOMEPAGE_ID!="0"#]
            window_url='<#ROOTHTML#>page/[#HOMEPAGE_ID#].html';
            [#endif MENU_ITEM_ID#]
            [#if EXT_URL!=""#]
            window_url='[#EXT_URL#]';
            [#endif EXT_URL#]
            if (window_url!='') {
                $.fancybox.open({ src: window_url, type: 'iframe'});
            } else {
                var url="<#ROOTHTML#>ajax/plans.html?op=click&id=[#ID#]";
                $.ajax({
                    url: url,
                }).done(function(data) {
                    checkAllPlanStates();
                });
            }
        });
        [#endif CAN_BE_CLICKED#]
        [#end STATES#]

        $('#plan[#PLAN_ID#]').show();
        [#if PLAN_NEED_ZOOM="1"#]
        var svgElement = $('#plan[#PLAN_ID#] svg')[0];
        var panZoomTiger = svgPanZoom(svgElement,{
            zoomEnabled: true,
            controlIconsEnabled: true,
        });
        //var panZoom = svgPanZoom('#plan[#PLAN_ID#] svg');
        [#endif#]
        checkPlanTimer=setTimeout('checkAllPlanStates();', 5000);

        [#if PLAN_AUTO_ZOOM="1"#]
        setTimeout('planZoom();',2000);
        [#endif#]

        [#if WIDTH!=""#]
        $("#plan[#PLAN_ID#] svg").first().width('[#WIDTH#]');
        $("#plan[#PLAN_ID#]").width('[#WIDTH#]');
        [#endif#]
        [#if HEIGHT!=""#]
        $("#plan[#PLAN_ID#] svg").first().height('[#HEIGHT#]');
        $("#plan[#PLAN_ID#]").height('[#HEIGHT#]');
        [#endif#]

    });
</script>